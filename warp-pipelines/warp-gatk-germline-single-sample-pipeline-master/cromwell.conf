include required(classpath("application"))

backend {
  default = "LocalWithDocker" # Name your default backend here

  providers {
    LocalWithDocker {    # This is a custom backend provider name; you can call it what you want
      actor-factory = "cromwell.backend.impl.sfs.config.ConfigBackendLifecycleActorFactory"

# The backend custom configuration.
      config {

        # Optional limits on the number of concurrent jobs
        concurrent-job-limit = 1

        # If true submits scripts to the bash background using "&". Only usefull for dispatchers that do NOT submit
        # the job and then immediately return a scheduled job id.
        run-in-background = true

        # Root directory where Cromwell writes job results.  This directory must be
        # visible and writeable by the Cromwell process as well as the jobs that Cromwell
        # launches.
        root = "cromwell-executions" 

        # Root directory where Cromwell writes job results in the container. This value
        # can be used to specify where the execution folder is mounted in the container.
        # it is used for the construction of the docker_cwd string in the submit-docker
        # value above.
        dockerRoot = "/cromwell-executions"

        # `temporary-directory` creates the temporary directory for commands.
        #
        # If this value is not set explicitly, the default value creates a unique temporary directory, equivalent to:
        temporary-directory = "$(mktemp -d \"$PWD\"/tmp.XXXXXX)"
        #
        # The expression is run from the execution directory for the script. The expression must create the directory
        # if it does not exist, and then return the full path to the directory.
        #
        # To create and return a non-random temporary directory, use something like:
        # temporary-directory = "$(mkdir -p /mnt/nas1/projects/lasr/blendseq/warp-pipelines/warp-gatk-germline-single-sample-pipeline-master/tmp && echo /mnt/nas1/projects/lasr/blendseq/warp-pipelines/warp-gatk-germline-single-sample-pipeline-master/tmp)"

        # `script-epilogue` configures a shell command to run after the execution of every command block.
        #
        # If this value is not set explicitly, the default value is `sync`, equivalent to:
        script-epilogue = "sync"
        #
        # To turn off the default `sync` behavior set this value to an empty string:
        # script-epilogue = ""

        # `glob-link-command` specifies command used to link glob outputs, by default using hard-links.
        # If filesystem doesn't allow hard-links (e.g., beeGFS), change to soft-links as follows:
        # glob-link-command = "ln -sL GLOB_PATTERN GLOB_DIRECTORY"
 
	      # The list of possible runtime custom attributes.
        runtime-attributes = """
        String? docker
        String? docker_user
        """

        # Submit string when there is no "docker" runtime attribute.
        # submit = "/usr/bin/env bash ${script}"

        # Submit string when there is a "docker" runtime attribute.
        # submit-docker = """
        # docker run \
        #   --rm -i \
        #   --user 1027:1028 \
        #   --cpus="10" \
        #   --memory="49000m" \
        #   --entrypoint ${job_shell} \
        #   -v ${cwd}:${docker_cwd} \
        #   ${docker} ${docker_script}
        # """

        # from the sfs config example at cromwell/core/src/main/resources/reference_local_provider_config.inc.conf

        submit = "${job_shell} ${script}"

        submit-docker = """
          # make sure there is no preexisting Docker CID file
          rm -f ${docker_cid}
          # run as in the original configuration without --rm flag (will remove later)
          docker run \
            --cidfile ${docker_cid} \
            -i \
            --user 1027:1028 \
            --cpus="64" \
            --memory="204800M" \
            --entrypoint ${job_shell} \
            -v ${cwd}:${docker_cwd} \
            ${docker} ${docker_script}

          # get the return code (working even if the container was detached)
          rc=$(docker wait `cat ${docker_cid}`)

          # remove the container after waiting
          docker rm `cat ${docker_cid}`

          # return exit code
          exit $rc
        """

        kill-docker = "docker kill `cat ${docker_cid}`"

        # File system handling - how Cromwell localizes (moves/links/copies) task input/output files
        filesystems {
          local {
            # caching.duplication-strategy = ["copy"]
            localization = ["soft-link", "cached-copy", "copy"]
            # docker.allow-soft-links = true

             # Call caching strategies
            caching {
              
              duplication-strategy = ["copy"]
              # Possible values: file, path
              # "file" will compute an md5 hash of the file content.
              # "path" will compute an md5 hash of the file path. This strategy will only be effective if the duplication-strategy (above) is set to "soft-link",
              # in order to allow for the original file path to be hashed.
              hashing-strategy: "file"

              # When true, will check if a sibling file with the same name and the .md5 extension exists, and if it does, use the content of this file as a hash.
              # If false or the md5 does not exist, will proceed with the above-defined hashing strategy.
              check-sibling-md5: false
            }
          }
        }
        docker {
          hash-lookup {

            # Time in minutes before an entry expires from the docker hashes cache and needs to be fetched again
            #cache-entry-ttl = "20 minutes"

            # Maximum number of elements to be kept in the cache. If the limit is reached, old elements will be removed from the cache
            cache-size = 200

            # How should docker hashes be looked up. Possible values are "local" and "remote"
            # "local": Lookup hashes on the local docker daemon using the cli
            # "remote": Lookup hashes on docker hub, gcr, gar, quay
            #method = "remote"
            
            allow-soft-links = true
          }

          allow-soft-links = true
        }
        # The defaults for runtime attributes if not provided.
        default-runtime-attributes {
          failOnStderr: false 
          continueOnReturnCode: 0
          cpu: 12
          memory: "4 MB"
        }
      }
    }
  }
}
